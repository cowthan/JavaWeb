#okhttp3学习笔记

关于okhttp3怎么用，帖子太多了，但没见过源码分析什么的，  
我会分析源码吗？不会  
先对文档做个翻译吧，自己学习用
-------------------------------------------------------

## 1 项目结构

###okcurl

* 简介
    * 这个是一个仿curl的命令行工具，使用okhttp发起请求，用来测试
    * 只有一个类，Main，代码很清楚
    * 为什么代码这么清楚，因为用了io.airlift.airline来处理命令行参数，这是个什么框架，注解？命令行？


###benchmarks

* 简介
    * performance测试，用来测试各种http客户端的性能，包括okhttp，URLconnection，apache，netty等
    * 文档不多，还没弄明白
    * If you made modifications to `Benchmark` run `mvn compile`
    * Run `mvn exec:exec` to launch a new JVM, which will execute the benchmark
    

###mockwebserver

* 简介
    * 脚本化的web服务器，用来测试http客户端
    * 可以检查发起的request是不是你认为的那样
    * 可以选择响应，可以从真实项目把响应内容拷过来，这个还是很有意义的
    * 可以模拟404,500等错误，来考验你的http请求代码
    * 还可以模拟网速慢的情况，哎呦我日了（tip：throttle翻译成节流阀）
    * 怎么翻译？Because it exercises your full HTTP stack, you can be confident that you're testing everything.
    
####基本用法

```java
public void test() throws Exception {
  // Create a MockWebServer. These are lean enough that you can create a new
  // instance for every unit test.
  MockWebServer server = new MockWebServer();

  // Schedule some responses.
  server.enqueue(new MockResponse().setBody("hello, world!"));
  server.enqueue(new MockResponse().setBody("sup, bra?"));
  server.enqueue(new MockResponse().setBody("yo dog"));

  // Start the server.
  server.start();

  // Ask the server for its URL. You'll need this to make HTTP requests.
  HttpUrl baseUrl = server.url("/v1/chat/");

  // Exercise your application code, which should make those HTTP requests.
  // Responses are returned in the same order that they are enqueued.
  Chat chat = new Chat(baseUrl);

  chat.loadMore();
  assertEquals("hello, world!", chat.messages());

  chat.loadMore();
  chat.loadMore();
  assertEquals(""
      + "hello, world!\n"
      + "sup, bra?\n"
      + "yo dog", chat.messages());

  // Optional: confirm that your app made the HTTP requests you were expecting.
  RecordedRequest request1 = server.takeRequest();
  assertEquals("/v1/chat/messages/", request1.getPath());
  assertNotNull(request1.getHeader("Authorization"));

  RecordedRequest request2 = server.takeRequest();
  assertEquals("/v1/chat/messages/2", request2.getPath());

  RecordedRequest request3 = server.takeRequest();
  assertEquals("/v1/chat/messages/3", request3.getPath());

  // Shut down the server. Instances cannot be reused.
  server.shutdown();
}
```

####使用Dispatcher

这段代码比较有参考意义，给MockWebServer设置个Dispatcher，根据不同的请求路径，给不同的响应
```java
final Dispatcher dispatcher = new Dispatcher() {

    @Override
    public MockResponse dispatch(RecordedRequest request) throws InterruptedException {

        if (request.getPath().equals("/v1/login/auth/")){
            return new MockResponse().setResponseCode(200);
        } else if (request.getPath().equals("v1/check/version/")){
            return new MockResponse().setResponseCode(200).setBody("version=9");
        } else if (request.getPath().equals("/v1/profile/info")) {
            return new MockResponse().setResponseCode(200).setBody("{\\\"info\\\":{\\\"name\":\"Lucas Albuquerque\",\"age\":\"21\",\"gender\":\"male\"}}");
        }
        return new MockResponse().setResponseCode(404);
    }
};
server.setDispatcher(dispatcher);
```

####构造个Response

```java
MockResponse response = new MockResponse()
    .addHeader("Content-Type", "application/json; charset=utf-8")
    .addHeader("Cache-Control", "no-cache")
    .setBody("{}");
    
//模拟网速慢的情况
response.throttleBody(1024, 1, TimeUnit.SECONDS);

//404和500也可以模仿
```

####检查Request

```java
RecordedRequest request = server.takeRequest();
assertEquals("POST /v1/chat/send HTTP/1.1", request.getRequestLine());
assertEquals("application/json; charset=utf-8", request.getHeader("Content-Type"));
assertEquals("{}", request.getBody().readUtf8());
```


###HttpLoggingInterceptor

An [OkHttp interceptor][1] which logs HTTP request and response data.

```java
HttpLoggingInterceptor logging = new HttpLoggingInterceptor();
logging.setLevel(Level.BASIC);
OkHttpClient client = new OkHttpClient.Builder()
  .addInterceptor(logging)
  .build();
```

You can change the log level at any time by calling `setLevel`.

To log to a custom location, pass a `Logger` instance to the constructor.
```java
HttpLoggingInterceptor logging = new HttpLoggingInterceptor(new Logger() {
  @Override public void log(String message) {
    Timber.tag("OkHttp").d(message);
  }
});
```

**Warning**: The logs generated by this interceptor when using the `HEADERS` or `BODY` levels has
the potential to leak sensitive information such as "Authorization" or "Cookie" headers and the
contents of request and response bodies. This data should only be logged in a controlled way or in
a non-production environment.

 [1]: https://github.com/square/okhttp/wiki/Interceptors